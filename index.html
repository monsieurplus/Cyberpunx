<!DOCTYPE html>
<html>
	<head>
		<title>PUTTI UNLIMITED</title>

		<!-- <link href='https://fonts.googleapis.com/css?family=VT323' rel='stylesheet' type='text/css' /> -->
		<link href='./resource/font/VT323.css' rel='stylesheet' type='text/css' />

		<script type="text/javascript" src="./controller/Playback.js"></script>
		<script type="text/javascript" src="./controller/Display.js"></script>

		<script type="text/javascript" src="./layer/VideoLayer.js"></script>
		<script type="text/javascript" src="./layer/HudLogoLayer.js"></script>
		<script type="text/javascript" src="./layer/HudClockLayer.js"></script>
		<script type="text/javascript" src="./layer/HudAudioLayer.js"></script>
		<script type="text/javascript" src="./layer/HudFilterLayer.js"></script>
		<script type="text/javascript" src="./layer/AnimatedSprite.js"></script>
		<script type="text/javascript" src="./layer/InvasionGame.js"></script>
		<script type="text/javascript" src="./layer/AlertMessage.js"></script>
		<script type="text/javascript" src="./layer/HudGlitchLayer.js"></script>
		<script type="text/javascript" src="./layer/NoiseLayer.js"></script>

		<script type="text/javascript">
		/* Layers init */

		// Globals
		var playback, display;

		document.addEventListener('DOMContentLoaded', function() {
			// Create the video (it's not inserted into the page)
			var video = document.createElement("video");
			//video.loop = "loop";
			video.preload = "auto";

			var videoSourceMp4 = document.createElement("source");
			videoSourceMp4.src = "./resource/video/punk-the-system.mp4";
			videoSourceMp4.type = "video/mp4";
			video.appendChild(videoSourceMp4)

			// Create the video playback controller
			playback = new Playback(video);
			setTimeout(function() {
				playback.seek(0);
				playback.play();
			}, 500);
			

			// Create the Display controller (it will handle the layers)
			display = new Display();

			// Create and insert the VideoLayer
			var videoLayer = new VideoLayer();
			videoLayer.setVideo(video);
			display.addLayer("video", videoLayer);
			
			// Create and insert HudLogoLayer
			var hudLogoLayer = new HudLogoLayer();
			hudLogoLayer.setActive(false);
			display.addLayer("hudLogo", hudLogoLayer);

			// Create and insert HudClockLayer
			var hudClockLayer = new HudClockLayer();
			hudClockLayer.setActive(false);
			display.addLayer("hudClock", hudClockLayer);

			// Create and insert HudAudioLayer
			var hudAudioLayer = new HudAudioLayer();
			hudAudioLayer.setMedia(video);
			hudAudioLayer.setActive(false);
			display.addLayer("hudAudio", hudAudioLayer);

			// Create and insert HudFilterLayer (filter buttons)
			var hudFilterLayer = new HudFilterLayer();
			hudFilterLayer.setActive(false);
			display.addLayer("hudFilter", hudFilterLayer);

			// Create and insert the doctor speech
			var drSpeech = new AnimatedSprite();
			drSpeech.setActive(false);
			drSpeech.setSpriteImage("./resource/image/dr-speech-sprites.jpg");
			drSpeech.setSpriteSize(480, 270);
			drSpeech.setDisplayPosition({
				left : 20,
				bottom : 200
			});
			drSpeech.setDisplaySize(240, 135);
			drSpeech.addAnimation("speak-close", [
				{ sprite :  0, duration : 100 },
				{ sprite :  1, duration : 100 },
				{ sprite :  2, duration : 100 },
				{ sprite :  4, duration : 100 }
			]);
			drSpeech.addAnimation("speak-far", [
				{ sprite :  9, duration : 100 },
				{ sprite : 10, duration : 100 },
				{ sprite : 11, duration : 100 },
				{ sprite : 18, duration : 100 },
				{ sprite : 20, duration : 100 }
			]);
			drSpeech.addAnimation("speak-very-far", [
				{ sprite : 55, duration : 100 },
				{ sprite : 57, duration : 100 }
			]);
			drSpeech.addAnimation("idle", [
				//{ sprite : 25, duration : 100 },
				//{ sprite :  9, duration : 100 },
				//{ sprite :  8, duration : 100 }
				{ sprite :  4, duration : 250 },
				{ sprite :  2, duration : 250 },
			]);
			drSpeech.addAnimation("scratch-front", [
				{ sprite : 28, duration : 100 },
				{ sprite : 43, duration : 100 },
				{ sprite : 50, duration : 100 },
				{ sprite : 54, duration : 100 },
				{ sprite : 56, duration : 100 }
			]);
			drSpeech.addAnimation("scratch-ear", [
				{ sprite : 15, duration : 100 },
				{ sprite : 48, duration : 100 },
				{ sprite : 53, duration : 100 }
			]);
			drSpeech.addAnimation("speak-right", [
				{ sprite : 24, duration : 100 },
				{ sprite : 26, duration : 100 },
				{ sprite : 30, duration : 100 },
				{ sprite : 32, duration : 100 },
				{ sprite : 12, duration : 100 },
				{ sprite : 13, duration : 100 },
				{ sprite : 16, duration : 100 },
				{ sprite : 17, duration : 100 }
			]);
			display.addLayer("drSpeech", drSpeech);

			var invasionGame = new InvasionGame();
			invasionGame.setActive(false);
			display.addLayer("invasionGame", invasionGame);

			var alertMessage = new AlertMessage();
			alertMessage.setActive(false);
			display.addLayer("alertMessage", alertMessage);

			var hudGlitchLayer = new HudGlitchLayer();
			hudGlitchLayer.setParam("quantity", 1);
			hudGlitchLayer.setParam("probability", 10);
			hudGlitchLayer.setParam("width", 10);
			hudGlitchLayer.setParam("height", 10);
			//hudGlitchLayer.setActive(false);
			display.addLayer("hudGlitch", hudGlitchLayer);

			var noiseLayer = new NoiseLayer();
			noiseLayer.setActive(false);
			display.addLayer("noise", noiseLayer);

			// Video glitches example
			/*window.setInterval(function() {
				var duration = 10 + Math.floor(Math.random() * 250);
				videoLayer.addGlitch({
					amount     : 1,
					seed       : 1,
					iterations : 3,
					quality    : 90
				}, duration);
			}, 1000);*/

			// Display loop and FPS counter handling
			var fps = 0;
			var fpsCounter = document.getElementById("fps-counter");
			var fpsMax = 30;
			var fpsMaxLastDraw = 0;
			var fpsMaxMinDelay = 1000/fpsMax;

			function displayLoop(time) {
				var timeSinceLastDraw = time - fpsMaxLastDraw; // Time since last draw
				if (timeSinceLastDraw >= fpsMaxMinDelay) {
					fpsMaxLastDraw = time;

					display.clear();
					display.draw(timeSinceLastDraw);
					fps++;
				}

				requestAnimationFrame(displayLoop);
			}
			requestAnimationFrame(displayLoop);

			window.setInterval(function() {
				fpsCounter.innerHTML = fps + "fps";
				fps = 0;
			}, 1000);
		});
		</script>

		<script type="text/javascript">
		/* Window resizing handling */
		document.addEventListener('DOMContentLoaded', function() {
			// window.resize event can fire quite fast, so we wait for the final resize to do something
			var resizeTimeout = null;

			var resizeEventHandler = function() {
				// Check if the display has been defined
				if (typeof display === "undefined") {
					return false;
				}

				// If a timeout is alive, we clear it
				if (resizeTimeout !== null) {
					clearTimeout(resizeTimeout);
				}

				// Launching a new timeout
				resizeTimeout = setTimeout(resizeTimeoutFinished, 500);
			};

			var resizeTimeoutFinished = function() {
				// Resize the display handler
				display.resize();

				// Back to null
				resizeTimeout = null;
			};

			window.addEventListener("resize", resizeEventHandler);
		});
		</script>

		<!-- HUD filter buttons initiliazing -->
		<script type="text/javascript">
		/* HUD filter button scripting */
		document.addEventListener('DOMContentLoaded', function() {
			var hudFilterLayer = display.getLayer("hudFilter");
			var videoLayer = display.getLayer("video");

			// Toggle a filter and its button
			var toggleFilter = function(buttonName, filterName, filterValue) {
				var isSelected = hudFilterLayer.isButtonSelected(buttonName);

				// Reset buttons and filters
				videoLayer.setFilter("none");
				hudFilterLayer.setAllButtonSelected(false);

				// Activate button and filter
				if (!isSelected) {
					videoLayer.setFilter(filterName, filterValue);
					hudFilterLayer.setButtonSelected(buttonName, true);
				}
			};

			hudFilterLayer.addButton("BRIGHTNESS", function() {
				toggleFilter("BRIGHTNESS", "brightness");
			});	

			hudFilterLayer.addButton("CONTRAST", function() {
				toggleFilter("CONTRAST", "contrast");
			});

			hudFilterLayer.addButton("ZOOM", function() {
				toggleFilter("ZOOM", "zoom");
			});

			hudFilterLayer.addButton("ACID", function() {
				toggleFilter("ACID", "predator");
			});

			hudFilterLayer.addButton("T800", function() {
				toggleFilter("T800", "terminator");
			});

			hudFilterLayer.addButton("INVERT", function() {
				toggleFilter("INVERT", "invert");
			});	
		});
		</script>

		<script type="text/javascript">
		/* Timed events scripting */
		document.addEventListener("DOMContentLoaded", function() {
			// Displays a video time counter
			var timeCounter = document.getElementById("time-counter");
			playback.progress(function(position) {
				timeCounter.innerHTML = Math.round(position * 100) / 100;
			});

			var setActiveHud = function(active) {
				display.getLayer("hudClock").setActive(active);
				display.getLayer("hudAudio").setActive(active);
				display.getLayer("hudLogo").setActive(active);
			};

			// Scene 1 : Hospital : Awakening
			// Scene 2 : Home : Discovery of the implant
			// Scene 3 : Studio
			// Scene 4 : Home : Shelter
			// Scene 5 : Home : Attack of the implant
			// Scene 6 : Home : Punk End
			// Scene 7 : Home : Good citizen End

			// Scene 1 : Begginning
			playback.when(2.35, function() {
				setActiveHud(true);

				display.getLayer("hudClock").setTime("08:35:54");
			});

			// Scene 1 : End
			playback.when(34.9, function() {
				setActiveHud(false);
			});

			// Scene 2 : Begginning
			playback.when(37, function() {
				setActiveHud(true);

				display.getLayer("hudClock").setTime("11:13:41");

				display.getLayer("hudFilter").setActive(true);
			});

			// Scene 2 : Dr. speech start
			playback.when(43, function() {
				var drSpeech = display.getLayer("drSpeech");
				drSpeech.setActive(true);
				drSpeech.playAnimation("speak-close");
			});
			playback.when(45, function() {
				display.getLayer("drSpeech").playAnimation("scratch-front");
			});
			playback.when(48, function() {
				display.getLayer("drSpeech").playAnimation("speak-far");
			});
			playback.when(52, function() {
				display.getLayer("drSpeech").playAnimation("scratch-ear");
			});
			playback.when(55, function() {
				display.getLayer("drSpeech").playAnimation("speak-right");
			});
			playback.when(57, function() {
				display.getLayer("drSpeech").playAnimation("idle");
			});

			// Scene 2 : Dr speech end
			playback.when(76, function() {
				// Stop the filters
				display.getLayer("hudFilter").setActive(false);
				display.getLayer("video").resetFilter();

				// Stop the doctor
				display.getLayer("drSpeech").setActive(false);
			});

			// Scene 2 : Music interruption
			playback.when(85, function() {
				var alertMessage = display.getLayer("alertMessage");
				alertMessage.setMessage("ALLOCUTION PRESIDENTIELLE OBLIGATOIRE");
				alertMessage.setColor("#6AFF0B");
				alertMessage.setBlinkSpeed(500);
				alertMessage.setActive(true);
			});

			// Scene 2 : Putti speech begins
			playback.when(90, function() {});

			// Scene 2 : End
			playback.when(120, function() {
				display.getLayer("alertMessage").setActive(false);

				setActiveHud(false);
			});

			// Scene 3 : Beggining
			playback.when(122.5, function() {
				setActiveHud(true);

				display.getLayer("hudClock").setTime("19:04:09");
			});

			// Scene 3 : Music starts
			playback.when(150, function() {});

			// Scene 3 : Censorship start
			playback.when(165, function() {
				var alertMessage = display.getLayer("alertMessage");
				alertMessage.setMessage("CONTENU PROHIBE DETECTE");
				alertMessage.setColor("#6AFF0B");
				alertMessage.setBlinkSpeed(250);
				alertMessage.setActive(true);
			});

			// Scene 3 : Music end
			playback.when(198, function() {
				display.getLayer("alertMessage").setActive(false);
			});

			// Scene 3 : End
			playback.when(210, function() {
				setActiveHud(false);
			});			

			// Scene 4 : Beginning
			playback.when(213, function() {
				setActiveHud(true);

				display.getLayer("hudClock").setTime("23:05:30");
			});

			// Scene 4 : End
			playback.when(240, function() {
				setActiveHud(false);
				display.getLayer("hudClock").setTime("03:00:37");
			});

			// Scene 5 : Implant boot
			playback.when(246, function() {
				setActiveHud(true);
			});

			// Scene 5 : Update start
			playback.when(249, function() {
				var alertMessage = display.getLayer("alertMessage");
				alertMessage.setMessage("MISE A JOUR EN COURS");
				alertMessage.setColor("#6AFF0B");
				alertMessage.setBlinkSpeed(500);
				alertMessage.setActive(true);

				var invasionGame = display.getLayer("invasionGame");
				invasionGame.setActive(true);
				invasionGame.setAttackerSize(5);
				invasionGame.setAttackerSpeed(5);
				invasionGame.setAttackerDelay(2000);
				invasionGame.setAttackerStrength(1);
				invasionGame.setAttackerColor("#6AFF0B");

				invasionGame.setFailureCallback(function() {
					// Jump to scene 7
					invasionGame.setActive(false);
					playback.seek(382);
				});
			});

			// Scene 5 : Awakening
			playback.when(255, function() {
				var alertMessage = display.getLayer("alertMessage");
				alertMessage.setColor("blue");
				alertMessage.setBlinkSpeed(250);

				var invasionGame = display.getLayer("invasionGame");
				invasionGame.setAttackerSize(5);
				invasionGame.setAttackerSpeed(7.5);
				invasionGame.setAttackerDelay(1500);
				invasionGame.setAttackerStrength(2);
				invasionGame.setAttackerColor("blue");
			});

			playback.when(275, function() {
				var alertMessage = display.getLayer("alertMessage");
				alertMessage.setColor("red");
				alertMessage.setBlinkSpeed(100);

				var invasionGame = display.getLayer("invasionGame");
				invasionGame.setAttackerSize(10);
				invasionGame.setAttackerSpeed(12.5);
				invasionGame.setAttackerDelay(500);
				invasionGame.setAttackerStrength(5);
				invasionGame.setAttackerColor("red");
			});

			// Scene 5 : End
			playback.when(309, function() {
				setActiveHud(false);
				display.getLayer("alertMessage").setActive(false);
				display.getLayer("invasionGame").setActive(false);
			});

			// Scene 6 : Beginning
			playback.when(311, function() {
				setActiveHud(true);

				var alertMessage = display.getLayer("alertMessage");
				alertMessage.setMessage("ECHEC CRITIQUE");
				alertMessage.setColor("red");
				alertMessage.setBlinkSpeed(100);
				alertMessage.setActive(true);

				var hudGlitch = display.getLayer("hudGlitch");
				hudGlitch.setActive(true);
				hudGlitch.setParam("quantity", 4);
				hudGlitch.setParam("probability", 25);
				hudGlitch.setParam("width", 10);
				hudGlitch.setParam("height", 10);

				display.getLayer("hudClock").setTime("03:35:12");
			});

			var generateGlitch = function() {
				var duration = 10 + Math.floor(Math.random() * 250);
				display.getLayer("video").addGlitch({
					amount     : 5,
					seed       : 5,
					iterations : 5,
					quality    : 75
				}, duration);
			};

			var changeMessage = function() {
				var messages = [
					"INTERFACE DEFAILLANTE",
					"CONNEXION INCOMPLETE",
					"BIOSONDE DEFECTUEUSE",
					"NIVEAU ENERGIE CRITIQUE",
					"MENACE EXTERIEURE DETECTEE",
					"ANCRAGE NEURONAL ENDOMMAGE",
					"FONCTION NORMALISATRICE COMPROMISE",
					"ANCRAGE CRANIEN DEFAILLANT",
					"IMPLANTATION NERVEUSE INCORRECTE"
				];

				var colors = ["red", "magenta", "pink", "fushia", "white"];

				var alertMessage = display.getLayer("alertMessage");
				alertMessage.setMessage(messages[Math.floor(Math.random() * messages.length)]);
				alertMessage.setColor(colors[Math.floor(Math.random() * colors.length)]);
				alertMessage.setBlinkSpeed(50 + Math.random() * 200);
				alertMessage.setActive(true);
			};

			// Scene 6 : First grip to remove the implant
			playback.when(329, function() {
				changeMessage();

				generateGlitch();

				var hudGlitch = display.getLayer("hudGlitch");
				hudGlitch.setActive(true);
				hudGlitch.setParam("quantity", 10);
				hudGlitch.setParam("probability", 50);
				hudGlitch.setParam("width", 10);
				hudGlitch.setParam("height", 10);
			});
			playback.when(330, function() {
				changeMessage();
				generateGlitch();
			});
			playback.when(331, function() {
				changeMessage();
				generateGlitch();
				generateGlitch();
			});
			playback.when(332, function() {
				changeMessage();
				generateGlitch();
				generateGlitch();
			});

			playback.when(333, function() {
				changeMessage();
				generateGlitch();
				generateGlitch();
			});
			playback.when(334, function() {
				changeMessage();
				generateGlitch();
				generateGlitch();
			});
			playback.when(335, function() {
				changeMessage();
				generateGlitch();
				generateGlitch();
			});
			playback.when(336, function() {
				changeMessage();
				generateGlitch();
				generateGlitch();
			});
			playback.when(337, function() {
				changeMessage();
				generateGlitch();
				generateGlitch();

				var hudGlitch = display.getLayer("hudGlitch");
				hudGlitch.setActive(true);
				hudGlitch.setParam("quantity", 50);
				hudGlitch.setParam("probability", 75);
				hudGlitch.setParam("width", 10);
				hudGlitch.setParam("height", 10);
			});
			playback.when(338, function() {
				changeMessage();
				generateGlitch();
				generateGlitch();
			});
			playback.when(339, function() {
				changeMessage();
				generateGlitch();
				generateGlitch();
			});
			playback.when(340, function() {
				changeMessage();
				generateGlitch();
				generateGlitch();
			});

			playback.when(341, function() {
				changeMessage();
				generateGlitch();
				generateGlitch();
			});
			playback.when(342, function() {
				changeMessage();
				generateGlitch();
				generateGlitch();
			});
			playback.when(343, function() {
				changeMessage();
				generateGlitch();
				generateGlitch();
			});

			// Scene 6 : Implant on the ground
			playback.when(344, function() {
				var alertMessage = display.getLayer("alertMessage");
				alertMessage.setMessage("ORGANISME HOTE INTROUVABLE");
				alertMessage.setColor("red");
				alertMessage.setBlinkSpeed(100);
				alertMessage.setActive(true);

				var hudGlitch = display.getLayer("hudGlitch");
				hudGlitch.setActive(true);
				hudGlitch.setParam("quantity", 50);
				hudGlitch.setParam("probability", 100);
				hudGlitch.setParam("width", 20);
				hudGlitch.setParam("height", 20);
			});

			// Scene 6 : Credits start
			playback.when(347.5, function() {
				display.getLayer("alertMessage").setActive(false);
				setActiveHud(false);
			});

			// Scene 6 : Credits end
			playback.when(380, function() {
				playback.pause();
			});

			// Scene 7 : Beggining
			playback.when(382, function() {
				setActiveHud(true);

				display.getLayer("hudClock").setTime("03:35:12");
			});

			// Scene 7 : change of light
			playback.when(398, function() {});

			// Scene 7 : music volume increase
			playback.when(455, function() {});

			// Scene 7 : Credits start
			playback.when(470, function() {
				setActiveHud(false);
			});

			// Scene 7 : Credits end
			playback.when(498, function() {
				playback.pause();
			});
		});
		</script>
		
		<style type="text/css">
			html, body {
				margin : 0;
				padding : 0;
				overflow : hidden;

				background-color : black;
			}
			#canvas-container canvas { position:absolute; top:0; left:0; z-index:1; opacity:0.75 ; }
			
			#video-container {
				position:absolute;
				top:0;
				left:0;
				right:0;
				bottom:0;

				-webkit-transition : -webkit-filter 0.5s linear;
				transition : filter 0.5s linear;
			}
			#video-container video {
				position : absolute;
				z-index : 0;

				-webkit-transition : all 0.5s linear;
				transition : all 0.5s linear;
			}
			.filter-terminator {
				-webkit-filter : contrast(5);
				filter : contrast(5);

				background-color : red;
			}
			.filter-terminator video {
				-webkit-filter : opacity(0.75) grayscale(1) brightness(4);
				filter : opacity(0.75) grayscale(1) brightness(4);
			}
			.filter-predator video {
				-webkit-filter : brightness(2) saturate(5) contrast(5);
				filter : brightness(2) saturate(5) contrast(5);
			}
			.filter-brightness video{
				-webkit-filter : brightness(4);
				filter : brightness(4);
			}
			.filter-contrast video{
				-webkit-filter : brightness(2) contrast(2);
				filter : brightness(2) contrast(2);
			}
			.filter-invert video{
				-webkit-filter : invert(1);
				filter : invert(1);
			}
			.filter-zoom video{
				transform : scale(2) ;
			}
		</style>
	</head>
	<body>
		<div id="fps-counter" style="position:absolute;top:0;right:0;color:white;z-index:2"></div>
		<div id="time-counter" style="position:absolute;top:0;left:0;color:white;z-index:2"></div>
		<div id="video-container"></div>
		<div id="canvas-container"></div>
	</body>
</html>