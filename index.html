<!DOCTYPE html>
<html>
	<head>
		<title>PUTTI UNLIMITED</title>

		<link href='https://fonts.googleapis.com/css?family=VT323' rel='stylesheet' type='text/css' />

		<script type="text/javascript" src="./controller/Playback.js"></script>
		<script type="text/javascript" src="./controller/Display.js"></script>

		<script type="text/javascript" src="./layer/VideoLayer.js"></script>
		<script type="text/javascript" src="./layer/HudLogoLayer.js"></script>
		<script type="text/javascript" src="./layer/HudClockLayer.js"></script>
		<script type="text/javascript" src="./layer/HudAudioLayer.js"></script>
		<script type="text/javascript" src="./layer/HudFilterLayer.js"></script>
		<script type="text/javascript" src="./layer/HudSpeech.js"></script>
		<script type="text/javascript" src="./layer/InvasionGame.js"></script>
		<script type="text/javascript" src="./layer/HudGlitchLayer.js"></script>
		<script type="text/javascript" src="./layer/NoiseLayer.js"></script>

		<script type="text/javascript">
		/* Layers init */

		// Globals
		var playback, display;

		document.addEventListener('DOMContentLoaded', function() {
			// Create the video (it's not inserted into the page)
			var video = document.createElement("video");
			//video.src = "./resource/video/cyberpunk2077.mp4";
			//video.src = "./resource/video/bbb.mp4";
			video.src = "./resource/video/punk-the-system.mp4";
			video.loop = true;
			video.preload = "auto";

			// Create the video playback controller
			playback = new Playback(video);
			playback.play();

			// Create the Display controller (it will handle the layers)
			display = new Display();

			// Create and insert the VideoLayer
			var videoLayer = new VideoLayer();
			videoLayer.setVideo(video);
			display.addLayer("video", videoLayer);
			
			// Create and insert HudLogoLayer
			var hudLogoLayer = new HudLogoLayer();
			//hudLogoLayer.setActive(false);
			display.addLayer("hudLogo", hudLogoLayer);

			// Create and insert HudClockLayer
			var hudClockLayer = new HudClockLayer();
			display.addLayer("hudClock", hudClockLayer);

			// Create and insert HudAudioLayer
			var hudAudioLayer = new HudAudioLayer();
			hudAudioLayer.setMedia(video);
			//hudAudioLayer.setActive(false);
			display.addLayer("hudAudio", hudAudioLayer);

			// Create and insert HudFilterLayer (filter buttons)
			var hudFilterLayer = new HudFilterLayer();
			hudFilterLayer.setActive(false);
			display.addLayer("hudFilter", hudFilterLayer);

			// Create and insert the doctor speech
			var drSpeech = new HudSpeech();
			drSpeech.setSpriteImage("./resource/image/dr-speech-sprites.jpg");
			drSpeech.setSpriteSize(480, 270);
			drSpeech.setDisplayPosition({
				left : 20,
				bottom : 200
			});
			var animation = [];
			for (var i = 0; i < 50; i++) {
				animation.push({
					index : i,
					duration : 100
				});
			}
			drSpeech.setActive(true);
			drSpeech.setAnimation(animation);
			drSpeech.setDisplaySize(240, 135);
			display.addLayer("drSpeech", drSpeech);

			var invasionGame = new InvasionGame();
			invasionGame.setActive(true);
			display.addLayer("invasionGame", invasionGame);

			var hudGlitchLayer = new HudGlitchLayer();
			hudGlitchLayer.setParam("quantity", 1);
			hudGlitchLayer.setParam("probability", 1);
			hudGlitchLayer.setParam("width", 10);
			hudGlitchLayer.setParam("height", 10);
			hudGlitchLayer.setActive(false);
			display.addLayer("hudGlitch", hudGlitchLayer);

			var noiseLayer = new NoiseLayer();
			noiseLayer.setActive(false);
			display.addLayer("noise", noiseLayer);

			// Video glitches example
			/*window.setInterval(function() {
				var duration = 10 + Math.floor(Math.random() * 250);
				videoLayer.addGlitch({
					amount     : 1,
					seed       : 1,
					iterations : 3,
					quality    : 90
				}, duration);
			}, 1000);*/

			// Display loop and FPS counter handling
			var fps = 0;
			var fpsCounter = document.getElementById("fps-counter");
			var fpsMax = 100;
			var fpsMaxLastDraw = 0;
			var fpsMaxMinDelay = 1000/fpsMax;

			function displayLoop(time) {
				var timeSinceLastDraw = time - fpsMaxLastDraw; // Time since last draw
				if (timeSinceLastDraw >= fpsMaxMinDelay) {
					fpsMaxLastDraw = time;

					display.clear();
					display.draw(timeSinceLastDraw);
					fps++;
				}

				requestAnimationFrame(displayLoop);
			}
			requestAnimationFrame(displayLoop);

			window.setInterval(function() {
				fpsCounter.innerHTML = fps + "fps";
				fps = 0;
			}, 1000);
		});
		</script>

		<script type="text/javascript">
		/* Window resizing handling */
		document.addEventListener('DOMContentLoaded', function() {
			// window.resize event can fire quite fast, so we wait for the final resize to do something
			var resizeTimeout = null;

			var resizeEventHandler = function() {
				// Check if the display has been defined
				if (typeof display === "undefined") {
					return false;
				}

				// If a timeout is alive, we clear it
				if (resizeTimeout !== null) {
					clearTimeout(resizeTimeout);
				}

				// Launching a new timeout
				resizeTimeout = setTimeout(resizeTimeoutFinished, 500);
			};

			var resizeTimeoutFinished = function() {
				// Resize the display handler
				display.resize();

				// Back to null
				resizeTimeout = null;
			};

			window.addEventListener("resize", resizeEventHandler);
		});
		</script>

		<!-- HUD filter buttons initiliazing -->
		<script type="text/javascript">
		/* HUD filter button scripting */
		document.addEventListener('DOMContentLoaded', function() {
			var hudFilterLayer = display.getLayer("hudFilter");
			var videoLayer = display.getLayer("video");

			// Toggle a filter and its button
			var toggleFilter = function(buttonName, filterName, filterValue) {
				var isSelected = hudFilterLayer.isButtonSelected(buttonName);

				// Reset buttons and filters
				videoLayer.setFilter("none");
				hudFilterLayer.setAllButtonSelected(false);

				// Activate button and filter
				if (!isSelected) {
					videoLayer.setFilter(filterName, filterValue);
					hudFilterLayer.setButtonSelected(buttonName, true);
				}
			};

			hudFilterLayer.addButton("BRIGHTNESS", function() {
				toggleFilter("BRIGHTNESS", "brightness");
			});	

			hudFilterLayer.addButton("CONTRAST", function() {
				toggleFilter("CONTRAST", "contrast");
			});

			hudFilterLayer.addButton("ZOOM", function() {
				toggleFilter("ZOOM", "zoom");
			});

			hudFilterLayer.addButton("ACID", function() {
				toggleFilter("ACID", "predator");
			});

			hudFilterLayer.addButton("T800", function() {
				toggleFilter("T800", "terminator");
			});

			hudFilterLayer.addButton("INVERT", function() {
				toggleFilter("INVERT", "invert");
			});	
		});
		</script>

		<script type="text/javascript">
		/* Timed events scripting */
		document.addEventListener("DOMContentLoaded", function() {
			var timeCounter = document.getElementById("time-counter");
			playback.progress(function(position) {
				timeCounter.innerHTML = Math.round(position * 100) / 100;
			})

			playback.when(37, function() {
				display.getLayer("hudFilter").setActive(true);

				var drSpeechLayer = display.getLayer("drSpeech");
				drSpeechLayer.setActive(true);
				drSpeechLayer.reset();
				drSpeechLayer.play();
			});

			playback.when(42, function() {
				display.getLayer("hudFilter").setActive(false);
				display.getLayer("video").resetFilter();
			})
		});
		</script>
		
		<style type="text/css">
			html, body {
				margin : 0;
				padding : 0;
				overflow : hidden;

				background-color : black;
			}
			#canvas-container canvas { position:absolute; top:0; left:0; z-index:1; }
			
			#video-container {
				position:absolute;
				top:0;
				left:0;
				right:0;
				bottom:0;

				-webkit-transition : -webkit-filter 0.5s linear;
				transition : filter 0.5s linear;
			}
			#video-container video {
				position : absolute;
				z-index : 0;

				-webkit-transition : all 0.5s linear;
				transition : all 0.5s linear;
			}
			.filter-terminator {
				-webkit-filter : contrast(5);
				filter : contrast(5);

				background-color : red;
			}
			.filter-terminator video {
				-webkit-filter : opacity(0.75) grayscale(1);
				filter : opacity(0.75) grayscale(1);
			}
			.filter-predator video {
				-webkit-filter : saturate(5) contrast(10);
				filter : saturate(5) contrast(10);
			}
			.filter-brightness video{
				-webkit-filter : brightness(2);
				filter : brightness(2);
			}
			.filter-contrast video{
				-webkit-filter : contrast(2);
				filter : contrast(2);
			}
			.filter-invert video{
				-webkit-filter : invert(1);
				filter : invert(1);
			}
			.filter-zoom video{
				transform : scale(2) ;
			}
		</style>
	</head>
	<body>
		<div id="fps-counter" style="position:absolute;top:0;right:0;color:white;z-index:2"></div>
		<div id="time-counter" style="position:absolute;top:0;left:0;color:white;z-index:2"></div>
		<div id="video-container"></div>
		<div id="canvas-container"></div>
	</body>
</html>